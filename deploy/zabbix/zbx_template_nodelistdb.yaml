zabbix_export:
  version: '6.4'
  templates:
    - uuid: 54e13f77b72b4b5a93bf72b13e6c131f
      template: NodelistDB
      name: 'NodelistDB FidoNet Server'
      description: |
        Monitoring template for NodelistDB server and testdaemon.
        Monitors health endpoint, ClickHouse connectivity, systemd services, and error rates.

        Requires deploy/zabbix/nodelistdb.conf installed on the agent host.
      groups:
        - name: Templates/Applications

      macros:
        - macro: '{$NODELISTDB.HEALTH.INTERVAL}'
          value: '60'
          description: 'Health check polling interval (seconds)'
        - macro: '{$NODELISTDB.DB.RESPONSE_MS.WARN}'
          value: '500'
          description: 'DB response time warning threshold (ms)'
        - macro: '{$NODELISTDB.DB.RESPONSE_MS.HIGH}'
          value: '2000'
          description: 'DB response time critical threshold (ms)'
        - macro: '{$NODELISTDB.ERROR.THRESHOLD}'
          value: '10'
          description: 'New errors per check interval for alerting'
        - macro: '{$NODELISTDB.NODATA.TIMEOUT}'
          value: '300'
          description: 'No data timeout before alerting (seconds)'

      valuemaps:
        - uuid: c18bd8ddefed4c009967fd6d28b72bd7
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up

      items:
        # ==============================
        # Master item: full health JSON
        # ==============================
        - uuid: d6ca23a67e5d46308f0a43faafeeac57
          name: 'NodelistDB health raw'
          key: nodelistdb.health
          delay: '{$NODELISTDB.HEALTH.INTERVAL}'
          history: 1h
          trends: '0'
          value_type: TEXT
          description: 'Raw JSON from /api/health endpoint. All dependent items parse fields from this.'
          tags:
            - tag: component
              value: health

        # ==============================
        # Dependent items (from health JSON)
        # ==============================
        - uuid: 43dd71c5c5ef4ce1837cdad222cd0a9a
          name: 'NodelistDB status'
          type: DEPENDENT
          key: nodelistdb.health.status
          delay: '0'
          history: 7d
          trends: '0'
          value_type: CHAR
          description: 'Health status: ok, degraded, or unreachable'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.status'
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: health

        - uuid: f5404e9b9ab645c495df996e90da7f73
          name: 'NodelistDB uptime'
          type: DEPENDENT
          key: nodelistdb.health.uptime
          delay: '0'
          history: 30d
          trends: 90d
          value_type: FLOAT
          units: s
          description: 'Server uptime in seconds'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.uptime_seconds'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: health

        - uuid: d1d8a71058a04404aa2ea8cd5925007a
          name: 'NodelistDB version'
          type: DEPENDENT
          key: nodelistdb.health.version
          delay: '0'
          history: 30d
          trends: '0'
          value_type: CHAR
          description: 'Server version string'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.version.version'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: health

        - uuid: bee67b6f2f134a3ab43b4cc8fa046deb
          name: 'NodelistDB DB connected'
          type: DEPENDENT
          key: nodelistdb.health.db.connected
          delay: '0'
          history: 7d
          trends: 90d
          value_type: UNSIGNED
          description: 'ClickHouse connection: 1=connected, 0=disconnected'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.database.connected'
            - type: BOOL_TO_DECIMAL
          master_item:
            key: nodelistdb.health
          valuemap:
            name: 'Service state'
          tags:
            - tag: component
              value: database

        - uuid: 2ee7c52a12ef445fb7e543a31ecea4c2
          name: 'NodelistDB DB response time'
          type: DEPENDENT
          key: nodelistdb.health.db.response_ms
          delay: '0'
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          units: ms
          description: 'ClickHouse ping response time in milliseconds'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.database.response_ms'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: database

        - uuid: 55222e3a2f5542baa528eefd39ff6cf6
          name: 'NodelistDB node count'
          type: DEPENDENT
          key: nodelistdb.health.nodes.count
          delay: '0'
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          description: 'Total nodes in the latest nodelist'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.nodes.count'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: data

        - uuid: 7c3b607f945b486fb4c86c349752f3c8
          name: 'NodelistDB latest nodelist date'
          type: DEPENDENT
          key: nodelistdb.health.nodes.date
          delay: '0'
          history: 30d
          trends: '0'
          value_type: CHAR
          description: 'Date of the latest imported nodelist'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.nodes.latest_date'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: data

        - uuid: 03936113a3494f53b30acc727073b333
          name: 'NodelistDB cache hit rate'
          type: DEPENDENT
          key: nodelistdb.health.cache.hit_rate
          delay: '0'
          history: 30d
          trends: 90d
          value_type: FLOAT
          units: '%'
          description: 'Cache hit rate percentage (only when cache enabled)'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.cache.hit_rate'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: cache

        - uuid: 519f269768264b339c61934a664f6a4d
          name: 'NodelistDB cache keys'
          type: DEPENDENT
          key: nodelistdb.health.cache.keys
          delay: '0'
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          description: 'Number of keys in the cache'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.cache.keys'
              error_handler: DISCARD_VALUE
          master_item:
            key: nodelistdb.health
          tags:
            - tag: component
              value: cache

        # ==============================
        # Direct UserParameter items
        # ==============================
        - uuid: d4d7b2038768469eb570d0ab5572aa7d
          name: 'NodelistDB server service'
          key: nodelistdb.service.server
          delay: '60'
          history: 7d
          trends: 90d
          value_type: UNSIGNED
          description: 'systemd nodelistdb service: 1=active, 0=down'
          valuemap:
            name: 'Service state'
          tags:
            - tag: component
              value: service

        - uuid: 2bb48876ec8d45b69c0cdc5996b18342
          name: 'NodelistDB testdaemon service'
          key: nodelistdb.service.testdaemon
          delay: '60'
          history: 7d
          trends: 90d
          value_type: UNSIGNED
          description: 'systemd nodelistdb-testdaemon service: 1=active, 0=down'
          valuemap:
            name: 'Service state'
          tags:
            - tag: component
              value: service

        - uuid: 984ff054d0d34d1ab419ff4b400c8281
          name: 'NodelistDB server log errors'
          key: nodelistdb.log.errors.server
          delay: '300'
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          description: 'Cumulative ERROR count in server.log. Use change() trigger for rate.'
          tags:
            - tag: component
              value: logs

        - uuid: 1855f095653e4961baff606572e131a7
          name: 'NodelistDB daemon log errors'
          key: nodelistdb.log.errors.daemon
          delay: '300'
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          description: 'Cumulative ERROR count in daemon.log. Use change() trigger for rate.'
          tags:
            - tag: component
              value: logs

  triggers:
    # --- HIGH ---
    - uuid: ac0d3902b6704579b6611e2445cdb3ff
      expression: 'last(/NodelistDB/nodelistdb.service.server)=0'
      name: 'NodelistDB server service is down'
      priority: HIGH
      description: 'The systemd nodelistdb service is not active.'
      tags:
        - tag: scope
          value: availability

    - uuid: 04f38738e9d2414a9d44d5b584686966
      expression: 'last(/NodelistDB/nodelistdb.health.status)="unreachable"'
      name: 'NodelistDB health endpoint unreachable'
      priority: HIGH
      description: 'Cannot reach /api/health - server may be down or unresponsive.'
      dependencies:
        - name: 'NodelistDB server service is down'
          expression: 'last(/NodelistDB/nodelistdb.service.server)=0'
      tags:
        - tag: scope
          value: availability

    - uuid: d7b870c4c35d40b0863f1c018f96efa4
      expression: 'last(/NodelistDB/nodelistdb.health.db.connected)=0'
      name: 'NodelistDB ClickHouse disconnected'
      priority: HIGH
      description: 'Database ping failed - ClickHouse may be down or unreachable.'
      dependencies:
        - name: 'NodelistDB health endpoint unreachable'
          expression: 'last(/NodelistDB/nodelistdb.health.status)="unreachable"'
      tags:
        - tag: scope
          value: availability

    # --- AVERAGE ---
    - uuid: e9b8117ccbf14bccb448aabb5573397f
      expression: 'nodata(/NodelistDB/nodelistdb.health,{$NODELISTDB.NODATA.TIMEOUT})=1'
      name: 'NodelistDB no health data for {$NODELISTDB.NODATA.TIMEOUT}s'
      priority: AVERAGE
      description: 'No health check data received - agent or server may be down.'
      dependencies:
        - name: 'NodelistDB server service is down'
          expression: 'last(/NodelistDB/nodelistdb.service.server)=0'
      tags:
        - tag: scope
          value: availability

    - uuid: f4f36b7b04b64deab73b2eea4e5d7e85
      expression: 'min(/NodelistDB/nodelistdb.health.db.response_ms,5m)>{$NODELISTDB.DB.RESPONSE_MS.HIGH}'
      name: 'NodelistDB DB response time critical (>{$NODELISTDB.DB.RESPONSE_MS.HIGH}ms)'
      priority: AVERAGE
      description: 'ClickHouse response time sustained above {$NODELISTDB.DB.RESPONSE_MS.HIGH}ms for 5 minutes.'
      dependencies:
        - name: 'NodelistDB ClickHouse disconnected'
          expression: 'last(/NodelistDB/nodelistdb.health.db.connected)=0'
      tags:
        - tag: scope
          value: performance

    # --- WARNING ---
    - uuid: ea61f5b83eee4b20870d59bdbab59cbe
      expression: 'last(/NodelistDB/nodelistdb.health.status)="degraded"'
      name: 'NodelistDB health status degraded'
      priority: WARNING
      description: 'Health check reports degraded status (likely a database issue).'
      dependencies:
        - name: 'NodelistDB health endpoint unreachable'
          expression: 'last(/NodelistDB/nodelistdb.health.status)="unreachable"'
      tags:
        - tag: scope
          value: performance

    - uuid: 4fc390194f544f409dfe63074bbc1328
      expression: 'min(/NodelistDB/nodelistdb.health.db.response_ms,5m)>{$NODELISTDB.DB.RESPONSE_MS.WARN}'
      name: 'NodelistDB DB response time elevated (>{$NODELISTDB.DB.RESPONSE_MS.WARN}ms)'
      priority: WARNING
      description: 'ClickHouse response time sustained above {$NODELISTDB.DB.RESPONSE_MS.WARN}ms for 5 minutes.'
      dependencies:
        - name: 'NodelistDB DB response time critical (>{$NODELISTDB.DB.RESPONSE_MS.HIGH}ms)'
          expression: 'min(/NodelistDB/nodelistdb.health.db.response_ms,5m)>{$NODELISTDB.DB.RESPONSE_MS.HIGH}'
      tags:
        - tag: scope
          value: performance

    - uuid: b196c40f41e54e84bbc2c8befe4c0f20
      expression: 'last(/NodelistDB/nodelistdb.service.testdaemon)=0'
      name: 'NodelistDB testdaemon service is down'
      priority: WARNING
      description: 'The systemd nodelistdb-testdaemon service is not active.'
      tags:
        - tag: scope
          value: availability

    - uuid: 020ee6bfe2d04f389db9fb9565c978d0
      expression: 'change(/NodelistDB/nodelistdb.log.errors.server)>{$NODELISTDB.ERROR.THRESHOLD}'
      name: 'NodelistDB server error rate elevated'
      priority: WARNING
      description: 'More than {$NODELISTDB.ERROR.THRESHOLD} new errors in server.log since last check.'
      tags:
        - tag: scope
          value: performance

    - uuid: b23785a798a3447687fa4dbc7ee90973
      expression: 'change(/NodelistDB/nodelistdb.log.errors.daemon)>{$NODELISTDB.ERROR.THRESHOLD}'
      name: 'NodelistDB daemon error rate elevated'
      priority: WARNING
      description: 'More than {$NODELISTDB.ERROR.THRESHOLD} new errors in daemon.log since last check.'
      tags:
        - tag: scope
          value: performance

    # --- INFO ---
    - uuid: fd737c4abb884c1588061dd421931741
      expression: 'last(/NodelistDB/nodelistdb.health.uptime)<600'
      name: 'NodelistDB server recently restarted'
      priority: INFO
      description: 'Server uptime is under 10 minutes - likely just restarted or deployed.'
      manual_close: 'YES'
      tags:
        - tag: scope
          value: notice

    - uuid: 54e13f77b72b4b5a93bf72b13e6c131e
      expression: 'change(/NodelistDB/nodelistdb.health.version)<>0'
      name: 'NodelistDB version changed'
      priority: INFO
      description: 'Server version has changed (deployment detected).'
      manual_close: 'YES'
      tags:
        - tag: scope
          value: notice
