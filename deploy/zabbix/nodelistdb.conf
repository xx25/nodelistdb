# NodelistDB Zabbix Agent UserParameter Configuration
# Deploy to:
#   zabbix_agent2: /etc/zabbix/zabbix_agent2.d/nodelistdb.conf
#   zabbix_agentd: /etc/zabbix/zabbix_agentd.conf.d/nodelistdb.conf
#
# After deploying, restart the agent:
#   systemctl restart zabbix-agent2   # or zabbix-agent
#
# Test with:
#   zabbix_agent2 -t nodelistdb.health

# Master item: full health JSON (Zabbix dependent items parse fields via JSONPath)
UserParameter=nodelistdb.health,curl -sf -m 10 http://localhost:8081/api/health || echo '{"status":"unreachable"}'

# systemd service status: 1=active, 0=inactive/failed
UserParameter=nodelistdb.service.server,systemctl is-active nodelistdb >/dev/null 2>&1 && echo 1 || echo 0
UserParameter=nodelistdb.service.testdaemon,systemctl is-active nodelistdb-testdaemon >/dev/null 2>&1 && echo 1 || echo 0

# Log error counts (total in current log file; Zabbix uses change() for rate detection)
UserParameter=nodelistdb.log.errors.server,grep -c 'level=ERROR' /var/log/nodelistdb/server.log 2>/dev/null || echo 0
UserParameter=nodelistdb.log.errors.daemon,grep -c 'level=ERROR' /var/log/nodelistdb/daemon.log 2>/dev/null || echo 0
